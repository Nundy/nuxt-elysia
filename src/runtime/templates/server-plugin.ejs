import Elysia from 'elysia'
import createElysiaApp from '<%= module %>'
import { defineNitroPlugin } from 'nitropack/runtime'
import { fromWebHandler } from 'h3'


const isBun = typeof Bun !== "undefined"

export default defineNitroPlugin(async (nitroApp) => {
  const app = await createElysiaApp({
    nitroApp,
  })

  nitroApp.hooks.hook('request', (event) => {
    event.context._elysiaApp = app
  })

  <%# å¤„ç† path ä¸ºå¯¹è±¡å½¢å¼çš„æƒ…å†µï¼ˆå¤šæœåŠ¡ï¼ŒAPIæœåŠ¡åˆ†ç¦»ï¼‰ %>
  <% if (typeof path === 'object') { %>
    <% const { host, port, prefix, isStart } = path %>

    <%# å¦‚æœé…ç½®äº†è‡ªåŠ¨å¯åŠ¨ç‹¬ç«‹APIæœåŠ¡ %>
    <% if (isStart) { %>
      // è‡ªåŠ¨å¯åŠ¨ç‹¬ç«‹çš„APIæœåŠ¡
      if (isBun) {
        // ä½¿ç”¨ Bun å¯åŠ¨æœåŠ¡
        /* const server = Bun.serve({
          port: <%= port %>,
          fetch: app.fetch,
        }) */
        // åˆ›å»ºå¸¦æœ‰å‰ç¼€çš„Elysiaåº”ç”¨
        <% if (prefix) { %>
          const prefixedApp = new Elysia({
            prefix: '<%= prefix %>'
          })
          prefixedApp.use(app)

          prefixedApp.listen(<%= port %>, () => {
            console.log(`ğŸ¦Š Elysia API server is running bun at <%= host %>:<%= port %><%= prefix %>`)
          })
        <% } else { %>
          // æ²¡æœ‰å‰ç¼€ï¼Œç›´æ¥å¯åŠ¨
          app.listen(<%= port %>, () => {
            console.log(`ğŸ¦Š Elysia API server is running bun at <%= host %>:<%= port %>`)
          })
        <% } %>
      } else {
        // ä½¿ç”¨ Node.js å¯åŠ¨æœåŠ¡ï¼Œé€‚é…Elysia WebStandard é€‚é…å™¨
        // åˆ›å»ºå¸¦æœ‰å‰ç¼€çš„Elysiaåº”ç”¨
        /* <% if (prefix) { %>
          const prefixedApp = new Elysia({
            prefix: '<%= prefix %>'
          })
          prefixedApp.use(app)
          prefixedApp.listen(<%= port %>, () => {
            console.log(`ğŸ¦Š Elysia API server is running at node <%= host %>:<%= port %><%= prefix %>`)
          })
        <% } else { %>
          // æ²¡æœ‰å‰ç¼€ï¼Œç›´æ¥å¯åŠ¨
          app.listen(<%= port %>, () => {
            console.log(`ğŸ¦Š Elysia API server is running at node <%= host %>:<%= port %>`)
          })
        <% } %> */
      }
    <% } %>

    // å°†APIæœåŠ¡çš„URLæ³¨å…¥åˆ°å…¨å±€ä¸Šä¸‹æ–‡ä¸­ï¼Œä¾›å®¢æˆ·ç«¯æ’ä»¶ä½¿ç”¨
    nitroApp.hooks.hook('request', (event) => {
      event.context._elysiaApiUrl = '<%= host %>:<%= port %>'
      event.context._elysiaApiPrefix = '<%= prefix %>'
    })

  <%# å¤„ç† path ä¸ºå­—ç¬¦ä¸²å½¢å¼çš„æƒ…å†µï¼ˆå•æœåŠ¡ï¼‰ %>
  <% } else if (path) { %>
    const appPath = '<%= path %>'
    if (appPath) {
      const wrappedApp = new Elysia({ prefix: appPath })

      <%# Fix missing Content-Type header when: - Running the app in Bun - The response is a string - Content-Type is not provided %>
      <% if (fixBunPlainTextResponse) { %>
        if (isBun) {
          wrappedApp.onAfterHandle(({ response, set }) => {
            if (typeof response === 'string' && !set.headers['content-type']) {
              set.headers['content-type'] = 'text/plain;charset=utf-8'
            }
          })
        }
      <% } %>

      wrappedApp.use(app)

      nitroApp.h3App.stack.unshift({
        route: appPath,
        <%# TODO See if Elysia can be configured to not return a response If the handle does not return a response, h3 will move to the next route in stack. If we can do this then we can register Elysia as '/' route https://h3.unjs.io/guide/app#registering-event-handlers %>
        handler: fromWebHandler(wrappedApp.handle),
      })
    }
  <% } %>
})